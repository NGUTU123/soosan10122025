---
import '../styles/global.css';
import '../components/blog/BlogStyles.css';
import FloatingWidgets from '../components/FloatingWidgets';
import GlobalSearch from '../components/GlobalSearch.astro';
import SocialMeta from '../components/seo/SocialMeta.astro';
import { getCollection } from 'astro:content';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article' | 'product';
  noindex?: boolean;
  canonical?: string;
}

const siteUrl = 'https://soosanmotor.com';

const {
  title = "Xe Tải & Đầu Kéo - Chuyên cung cấp xe tải chất lượng",
  description = "Chuyên cung cấp xe tải, đầu kéo, rơ moóc các loại. Tư vấn miễn phí, hỗ trợ vay vốn.",
  image = "/og-default.jpg",
  type = "website",
  noindex = false,
  canonical
} = Astro.props;

// Generate canonical URL
const currentPath = Astro.url.pathname;
const canonicalUrl = canonical || `${siteUrl}${currentPath}`;

// Robots directive
const robotsContent = noindex 
  ? 'noindex, nofollow' 
  : 'index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1';

// Get all products for order notifications
const allProducts = await getCollection('products');
const productsForNotifications = allProducts
  .filter(p => !p.data.isHidden)
  .map(p => ({
    name: p.data.name,
    type: p.data.type,
    slug: p.data.slug
  }));
---

<!DOCTYPE html>
<html lang="vi">
  <head>
    <!-- Primary Meta Tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    
    <!-- Robots & Crawlers -->
    <meta name="robots" content={robotsContent} />
    <meta name="googlebot" content={robotsContent} />
    <meta name="bingbot" content={robotsContent} />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- Language & Regional -->
    <meta http-equiv="Content-Language" content="vi" />
    <meta name="language" content="Vietnamese" />
    <meta name="geo.region" content="VN" />
    <meta name="geo.placename" content="Vietnam" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#dc2626" />
    <meta name="msapplication-TileColor" content="#dc2626" />
    
    <!-- Open Graph & Twitter Cards -->
    <SocialMeta 
      title={title}
      description={description}
      image={image}
      url={currentPath}
      type={type}
    />
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://cdn.soosanmotor.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://cdn.soosanmotor.com" />
    
    <!-- AI Crawlers Meta (GEO) -->
    <meta name="ai-content-declaration" content="human-created" />
    <meta name="generator" content="Astro" />
    
    <!-- Scripts -->
    <script is:inline src="/search-enhanced.js"></script>
  </head>
  <body>
    <slot />

    <!-- Floating widgets: QuickContact + OrderNotification -->
    <FloatingWidgets client:load products={productsForNotifications} />

    <!-- Global search enhancement -->
    <GlobalSearch />
  </body>
</html>
